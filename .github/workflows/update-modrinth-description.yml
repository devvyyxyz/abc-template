name: Update Modrinth Long Description

on:
  workflow_dispatch:
  push:
    paths:
      - 'README.md'

concurrency:
  group: update-modrinth-description
  cancel-in-progress: true

jobs:
  update-description:
    name: Upload README.md to Modrinth
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure secrets present
        run: |
          if [ -z "${{ secrets.MODRINTH_PROJECT_ID }}" ] || [ -z "${{ secrets.MODRINTH_API_TOKEN }}" ]; then
            echo "Required secrets MODRINTH_PROJECT_ID and MODRINTH_API_TOKEN are not set." >&2
            exit 1
          fi

      - name: Upload README.md as project long description
        env:
          MODRINTH_PROJECT_ID: ${{ secrets.MODRINTH_PROJECT_ID }}
          MODRINTH_API_TOKEN: ${{ secrets.MODRINTH_API_TOKEN }}
        run: |
          set -euo pipefail

          README_FILE=README.md
          if [ ! -f "$README_FILE" ]; then
            echo "No $README_FILE found in repository." >&2
            exit 1
          fi

          echo "Preparing payload to update project $MODRINTH_PROJECT_ID"

          PAYLOAD_FILE="/tmp/modrinth_payload.json"
          python3 -c "import json; print(json.dumps({'body': open('README.md', 'r', encoding='utf-8').read()}))" > "$PAYLOAD_FILE"

          API_URL="https://api.modrinth.com/v2/project/${MODRINTH_PROJECT_ID}"
          USER_AGENT="${GITHUB_REPOSITORY:-devvyyxyz/abc-capes}-modrinth-action"

          HTTP_STATUS=$(curl -sS -o /tmp/modrinth_response.txt -w "%{http_code}" \
            -X PATCH \
            -H "Authorization: ${MODRINTH_API_TOKEN}" \
            -H "User-Agent: ${USER_AGENT}" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data-binary @"${PAYLOAD_FILE}" \
            "${API_URL}") || true

          if [ "$HTTP_STATUS" = "204" ]; then
            echo "Modrinth project updated successfully (HTTP 204)."
          else
            echo "Failed to update Modrinth project (HTTP $HTTP_STATUS)." >&2
            echo "Response:" >&2
            sed -n '1,200p' /tmp/modrinth_response.txt >&2 || true
            exit 1
          fi

